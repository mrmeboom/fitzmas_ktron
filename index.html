<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitzMas Karaok-atron 3000</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fleur+De+Leah&family=Henny+Penny&display=swap" rel="stylesheet">

    <style>
        :root {
            --velvet-base: #4a0404;
            --velvet-highlight: #750b0b;
            --velvet-shadow: #210000;
            --gold-light: #fbe68b;
            --gold-mid: #d4af37;
            --gold-dark: #8a6e1e;
        }

        body {
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000; /* Fallback */
            font-family: "Henny Penny", system-ui;
        }

        /* --- LAYERS --- */
        #glCanvas, #snowCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #glCanvas { z-index: 0; }
        #snowCanvas { z-index: 1; pointer-events: none; }
        
        /* Main UI Container */
        .machine-container {
            position: relative;
            z-index: 10;
            
            /* Velvet Texture */
            background: radial-gradient(circle at 30% 30%, var(--velvet-highlight), var(--velvet-base) 60%, var(--velvet-shadow));
            
            /* Soft Pillowed Bevel */
            border-radius: 20px;
            box-shadow: 
                /* Top-left Highlight */
                inset 2px 2px 5px rgba(255, 255, 255, 0.15),
                /* Bottom-right Shadow */
                inset -3px -3px 8px rgba(0, 0, 0, 0.6),
                /* Deep Drop Shadow for 3D lift */
                0 30px 60px rgba(0, 0, 0, 0.8);

            padding: 50px;
            width: 90%;
            max-width: 800px;
            text-align: center;
            border: 1px solid rgba(0,0,0,0.3);
        }

        /* --- TYPOGRAPHY --- */
        .gold-text {
            /* Gold Gradient Fill */
            background: linear-gradient(to bottom, var(--gold-light) 0%, var(--gold-mid) 50%, var(--gold-dark) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            
            /* Physical ridge effect via drop-shadow since text-shadow doesn't work well with background-clip */
            filter: drop-shadow(0px 2px 0px rgba(0,0,0,0.5));
        }

        h1.title-main {
            font-family: "Fleur De Leah", cursive;
            font-size: 5rem;
            margin: 0;
            line-height: 0.8;
            padding-bottom: 10px;
            transform: rotate(-2deg); /* Jaunty angle */
        }

        h2.subtitle {
            font-family: "Henny Penny", system-ui;
            font-size: 2.2rem;
            margin: 0 0 40px 0;
            opacity: 0.9;
            letter-spacing: 1px;
        }

        /* --- SLOTS --- */
        .slots-wrapper {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .slot-window {
            /* Forest Green Base */
            background: #0f3b1e;
            
            /* Cylindrical Illusion */
            /* We use inset shadows to make the top and bottom look curved away from the light */
            box-shadow: 
                inset 0px 25px 30px -5px rgba(0,0,0,0.8),
                inset 0px -25px 30px -5px rgba(0,0,0,0.8),
                0 0 0 4px #1a1a1a, /* Inner bezel */
                0 0 0 6px var(--gold-dark); /* Outer gold trim */

            border-radius: 12px;
            width: 100%;
            max-width: 300px;
            height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .slot-label {
            position: absolute;
            top: 8px;
            font-family: "Henny Penny", system-ui;
            font-size: 1.0rem;
            color: rgba(255,255,255,0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 2;
        }

        .reel-text {
            font-family: "Henny Penny", system-ui;
            font-size: 1.8rem;
            line-height: 1.1;
            padding: 0 20px;
            z-index: 1;
        }

        /* --- BUTTON --- */
        button#spinBtn {
            font-family: "Henny Penny", system-ui;
            font-size: 2.5rem;
            text-transform: capitalize; /* Changed to capitalize for "Spin Again" look */
            letter-spacing: 1px;
            color: #3e2704; /* Dark gold/brown text */
            
            /* Gold Bar Gradient */
            background: linear-gradient(180deg, var(--gold-light) 0%, var(--gold-mid) 40%, var(--gold-dark) 100%);
            
            border: none;
            padding: 15px 80px;
            border-radius: 12px;
            cursor: pointer;
            
            /* Bevel */
            box-shadow: 
                inset 1px 1px 0px rgba(255,255,255,0.4),
                inset -1px -1px 0px rgba(0,0,0,0.2),
                0px 5px 10px rgba(0,0,0,0.5);
                
            transition: transform 0.1s, box-shadow 0.1s;
        }

        button#spinBtn:active {
            transform: translateY(2px);
            box-shadow: 
                inset 1px 1px 2px rgba(0,0,0,0.3),
                0px 2px 5px rgba(0,0,0,0.5);
        }
        
        button#spinBtn:disabled {
            filter: grayscale(0.8) brightness(0.7);
            cursor: not-allowed;
        }

        .status {
            margin-top: 25px;
            font-size: 1.2rem;
            color: var(--gold-mid);
            opacity: 0.8;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: radial-gradient(circle, var(--velvet-highlight), var(--velvet-base));
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 2px solid var(--gold-mid);
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.2);
        }
        .modal h2 { margin-top: 0; color: var(--gold-light); font-size: 3rem; font-family: "Fleur De Leah", cursive;}
        .modal p { color: var(--gold-mid); font-size: 1.5rem; }

        @media (max-width: 600px) {
            h1.title-main { font-size: 3.5rem; }
            h2.subtitle { font-size: 1.6rem; margin-bottom: 20px; }
            .slot-window { height: 100px; }
            .reel-text { font-size: 1.4rem; }
            .machine-container { padding: 30px 15px; }
        }
    </style>
</head>
<body>

    <!-- WebGL Background -->
    <canvas id="glCanvas"></canvas>
    <!-- Falling Snow Overlay -->
    <canvas id="snowCanvas"></canvas>

    <div class="machine-container">
        
        <h1 class="title-main gold-text">FitzMas</h1>
        <h2 class="subtitle gold-text">Karaok-atron 3000</h2>

        <div class="slots-wrapper">
            <div class="slot-window">
                <span class="slot-label">Singer</span>
                <div id="reel-name" class="reel-text gold-text">Ready?</div>
            </div>
            <div class="slot-window">
                <span class="slot-label">Song</span>
                <div id="reel-song" class="reel-text gold-text">Spin to Win</div>
            </div>
        </div>

        <button id="spinBtn" onclick="spin()">Spin!</button>

        <div class="status">
            Singers remaining: <span id="count">20</span>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div id="gameOverModal" class="modal">
        <div class="modal-content">
            <h2>Party Complete!</h2>
            <p>All colleagues have been selected!</p>
            <button onclick="location.reload()" style="margin-top:20px; background:var(--gold-mid); border:none; padding:10px 20px; font-family:'Henny Penny'; font-size:1.5rem; cursor:pointer; border-radius:5px;">Restart</button>
        </div>
    </div>

    <!-- SHADERS -->
    <script id="vertex-shader" type="x-shader/x-vertex">
        attribute vec2 a_position;
        void main() {
            gl_Position = vec4(a_position, 0.0, 1.0);
        }
    </script>

    <script id="fragment-shader" type="x-shader/x-fragment">
        precision mediump float;
        uniform vec2 u_resolution;
        uniform float u_time;

        // Simplex 3D Noise function (standard GLSL implementation)
        vec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
        vec4 mod289(vec4 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
        vec4 permute(vec4 x) { return mod289(((x*34.0)+1.0)*x); }
        vec4 taylorInvSqrt(vec4 r) { return 1.79284291400159 - 0.85373472095314 * r; }

        float snoise(vec3 v) { 
            const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;
            const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);

            vec3 i  = floor(v + dot(v, C.yyy) );
            vec3 x0 = v - i + dot(i, C.xxx) ;

            vec3 g = step(x0.yzx, x0.xyz);
            vec3 l = 1.0 - g;
            vec3 i1 = min( g.xyz, l.zxy );
            vec3 i2 = max( g.xyz, l.zxy );

            vec3 x1 = x0 - i1 + C.xxx;
            vec3 x2 = x0 - i2 + C.yyy; // 2.0*C.x = 1/3 = C.y
            vec3 x3 = x0 - D.yyy;      // -1.0+3.0*C.x = -0.5 = -D.y

            i = mod289(i); 
            vec4 p = permute( permute( permute( 
                        i.z + vec4(0.0, i1.z, i2.z, 1.0 ))
                    + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) 
                    + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));

            float n_ = 0.142857142857; // 1.0/7.0
            vec3  ns = n_ * D.wyz - D.xzx;

            vec4 j = p - 49.0 * floor(p * ns.z * ns.z);  //  mod(p,7*7)

            vec4 x_ = floor(j * ns.z);
            vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)

            vec4 x = x_ *ns.x + ns.yyyy;
            vec4 y = y_ *ns.x + ns.yyyy;
            vec4 h = 1.0 - abs(x) - abs(y);

            vec4 b0 = vec4( x.xy, y.xy );
            vec4 b1 = vec4( x.zw, y.zw );

            vec4 s0 = floor(b0)*2.0 + 1.0;
            vec4 s1 = floor(b1)*2.0 + 1.0;
            vec4 sh = -step(h, vec4(0.0));

            vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;
            vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;

            vec3 p0 = vec3(a0.xy,h.x);
            vec3 p1 = vec3(a0.zw,h.y);
            vec3 p2 = vec3(a1.xy,h.z);
            vec3 p3 = vec3(a1.zw,h.w);

            vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));
            p0 *= norm.x;
            p1 *= norm.y;
            p2 *= norm.z;
            p3 *= norm.w;

            vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);
            m = m * m;
            return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), 
                                        dot(p2,x2), dot(p3,x3) ) );
        }

        void main() {
            vec2 st = gl_FragCoord.xy / u_resolution.xy;
            st.x *= u_resolution.x / u_resolution.y;

            // Colors
            vec3 colorBg = vec3(0.05, 0.15, 0.1); // Deep Green Base (#0d261a)
            vec3 colorCloud = vec3(0.29, 0.05, 0.05); // Dark Red (#4a0e0e)

            // Noise evolution
            // Move through z-axis (u_time) slowly
            float n = snoise(vec3(st * 1.5, u_time * 0.1));
            
            // Second layer of detail
            float n2 = snoise(vec3(st * 4.0 + vec2(u_time*0.05), u_time * 0.15));

            // Combine
            float mask = smoothstep(-0.2, 0.6, n + n2 * 0.5);

            // Mix
            vec3 finalColor = mix(colorBg, colorCloud, mask);

            // Vignette
            vec2 uv = gl_FragCoord.xy / u_resolution.xy;
            float vignette = 1.0 - length(uv - 0.5) * 0.8;
            finalColor *= vignette;

            gl_FragColor = vec4(finalColor, 1.0);
        }
    </script>

    <script>
        // --- 1. WEBGL BACKGROUND ---
        const glCanvas = document.getElementById('glCanvas');
        const gl = glCanvas.getContext('webgl');

        let program;
        let positionLocation;
        let resolutionLocation;
        let timeLocation;
        let buffer;

        function createShader(gl, type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                console.error(gl.getShaderInfoLog(shader));
                gl.deleteShader(shader);
                return null;
            }
            return shader;
        }

        function initWebGL() {
            if (!gl) return;

            const vertexSource = document.getElementById('vertex-shader').text;
            const fragmentSource = document.getElementById('fragment-shader').text;

            const vertexShader = createShader(gl, gl.VERTEX_SHADER, vertexSource);
            const fragmentShader = createShader(gl, gl.FRAGMENT_SHADER, fragmentSource);

            program = gl.createProgram();
            gl.attachShader(program, vertexShader);
            gl.attachShader(program, fragmentShader);
            gl.linkProgram(program);

            if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
                console.error(gl.getProgramInfoLog(program));
                return;
            }

            positionLocation = gl.getAttribLocation(program, "a_position");
            resolutionLocation = gl.getUniformLocation(program, "u_resolution");
            timeLocation = gl.getUniformLocation(program, "u_time");

            buffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
                -1.0, -1.0, 1.0, -1.0, -1.0, 1.0,
                -1.0, 1.0, 1.0, -1.0, 1.0, 1.0
            ]), gl.STATIC_DRAW);
        }

        function resizeWebGL() {
            glCanvas.width = window.innerWidth;
            glCanvas.height = window.innerHeight;
            gl.viewport(0, 0, glCanvas.width, glCanvas.height);
        }

        // --- 2. SNOW CANVAS + PHYSICS ---
        const snowCanvas = document.getElementById('snowCanvas');
        const ctx = snowCanvas.getContext('2d');
        let flakes = [];
        let burstParticles = []; // For the explosion
        let wind = 0;

        function initSnow() {
            snowCanvas.width = window.innerWidth;
            snowCanvas.height = window.innerHeight;
            flakes = [];
            for(let i=0; i<70; i++) {
                flakes.push({
                    x: Math.random() * snowCanvas.width,
                    y: Math.random() * snowCanvas.height,
                    radius: Math.random() * 3 + 1,
                    speed: Math.random() * 1 + 0.5,
                    sway: Math.random() * 0.05,
                    offset: Math.random() * Math.PI * 2
                });
            }
        }

        // Create a snow explosion
        function createSnowBurst() {
            const centerX = snowCanvas.width / 2;
            const centerY = snowCanvas.height / 2;
            
            for(let i=0; i<150; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 10 + 2;
                burstParticles.push({
                    x: centerX,
                    y: centerY,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    radius: Math.random() * 4 + 2,
                    alpha: 1.0,
                    decay: Math.random() * 0.02 + 0.01,
                    gravity: 0.1
                });
            }
        }

        function updateAndDraw(time) {
            // Draw WebGL
            gl.useProgram(program);
            gl.enableVertexAttribArray(positionLocation);
            gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
            gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
            gl.uniform2f(resolutionLocation, glCanvas.width, glCanvas.height);
            gl.uniform1f(timeLocation, time * 0.001);
            gl.drawArrays(gl.TRIANGLES, 0, 6);

            // Update Wind (based on time, slow sine wave)
            wind = Math.sin(time * 0.0005) * 1.5;

            // Clear Snow Canvas
            ctx.clearRect(0, 0, snowCanvas.width, snowCanvas.height);

            // 1. Draw Regular Snow
            ctx.fillStyle = "rgba(255, 255, 255, 0.6)";
            ctx.beginPath();
            
            for(let f of flakes) {
                // Physics
                f.y += f.speed;
                // X movement = Wind + individual flake sway
                f.x += wind + Math.sin((time * 0.002) + f.offset) * 0.5;

                // Wrap around
                if (f.y > snowCanvas.height) f.y = -5;
                if (f.x > snowCanvas.width) f.x = 0;
                if (f.x < 0) f.x = snowCanvas.width;

                ctx.moveTo(f.x, f.y);
                ctx.arc(f.x, f.y, f.radius, 0, Math.PI * 2);
            }
            ctx.fill();

            // 2. Draw Burst Particles (Confetti Snow)
            if (burstParticles.length > 0) {
                for (let i = burstParticles.length - 1; i >= 0; i--) {
                    let p = burstParticles[i];
                    
                    // Move
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += p.gravity; // Gravity pull
                    p.alpha -= p.decay; // Fade out

                    if (p.alpha <= 0) {
                        burstParticles.splice(i, 1);
                        continue;
                    }

                    ctx.beginPath();
                    ctx.fillStyle = "rgba(255, 255, 255, " + p.alpha + ")";
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            requestAnimationFrame(updateAndDraw);
        }

        // --- 3. GAME LOGIC ---
        // 20 Colleagues
        let colleagues = Array.from({length: 20}, (_, i) => `Colleague ${i + 1}`);
        
        // 30 Christmas Hits
        let songs = [
            "All I Want for Christmas Is You", "Last Christmas", "Jingle Bell Rock", 
            "Rockin' Around the Christmas Tree", "Santa Tell Me", "It's Beginning to Look a Lot Like Christmas",
            "Underneath the Tree", "Let It Snow! Let It Snow!", "Feliz Navidad", "Sleigh Ride",
            "Holly Jolly Christmas", "Blue Christmas", "Wonderful Christmastime", "Santa Baby",
            "White Christmas", "Have Yourself a Merry Little Christmas", "Merry Christmas Everyone", 
            "Step Into Christmas", "Driving Home for Christmas", "I Wish It Could Be Christmas Everyday",
            "Do They Know It's Christmas?", "Fairytale of New York", "Mary's Boy Child", "Baby It's Cold Outside",
            "Winter Wonderland", "Frosty the Snowman", "Rudolph the Red-Nosed Reindeer", "Silent Night", 
            "Jingle Bells", "Santa Claus Is Coming to Town"
        ];

        const reelName = document.getElementById('reel-name');
        const reelSong = document.getElementById('reel-song');
        const spinBtn = document.getElementById('spinBtn');
        const countSpan = document.getElementById('count');
        const modal = document.getElementById('gameOverModal');
        let isSpinning = false;

        function spin() {
            if (isSpinning) return;
            if (colleagues.length === 0) {
                modal.style.display = 'flex';
                return;
            }

            isSpinning = true;
            spinBtn.disabled = true;
            spinBtn.innerText = "Spinning...";

            let delay = 50; 
            let iterations = 0;
            const minIterations = 20;

            const spinLoop = () => {
                const nameIdx = Math.floor(Math.random() * colleagues.length);
                const songIdx = Math.floor(Math.random() * songs.length);
                
                reelName.innerText = colleagues[nameIdx];
                reelSong.innerText = songs.length > 0 ? songs[songIdx] : "Free Choice!";
                
                iterations++;

                if (iterations > minIterations) {
                    delay = Math.floor(delay * 1.15);
                }

                if (delay < 600) {
                    setTimeout(spinLoop, delay);
                } else {
                    finishSpin(nameIdx, songIdx);
                }
            };
            spinLoop();
        }

        function finishSpin(nameIdx, songIdx) {
            colleagues.splice(nameIdx, 1);
            if(songs.length > 0) songs.splice(songIdx, 1);

            countSpan.innerText = colleagues.length;
            isSpinning = false;
            
            // Trigger Snow Burst Effect
            createSnowBurst();
            
            if (colleagues.length === 0) {
                spinBtn.innerText = "Finale!";
                setTimeout(() => { modal.style.display = 'flex'; }, 1000);
            } else {
                spinBtn.disabled = false;
                spinBtn.innerText = "Spin Again";
            }
        }

        // --- INIT ---
        window.addEventListener('resize', () => {
            resizeWebGL();
            initSnow();
        });
        
        initWebGL();
        resizeWebGL();
        initSnow();
        requestAnimationFrame(updateAndDraw);

    </script>
</body>
</html>
