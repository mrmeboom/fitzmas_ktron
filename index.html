<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitzMas Karaok-atron 3000</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fleur+De+Leah&family=Henny+Penny&display=swap" rel="stylesheet">

    <style>
        :root {
            --velvet-base: #4a0404;
            --velvet-highlight: #750b0b;
            --velvet-shadow: #210000;
            --gold-light: #fbe68b;
            --gold-mid: #d4af37;
            --gold-dark: #8a6e1e;
        }

        body {
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000; /* Fallback */
            font-family: "Henny Penny", system-ui;
        }

        /* --- LAYERS --- */
        #glCanvas, #snowCanvas, #burstCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #glCanvas { z-index: 0; }
        #snowCanvas { z-index: 1; pointer-events: none; }
        /* New layer for the explosion on top of the machine */
        #burstCanvas { z-index: 100; pointer-events: none; }
        
        /* Main UI Container */
        .machine-container {
            position: relative;
            z-index: 10;
            
            /* Velvet Texture */
            background: radial-gradient(circle at 30% 30%, var(--velvet-highlight), var(--velvet-base) 60%, var(--velvet-shadow));
            
            /* Soft Pillowed Bevel */
            border-radius: 20px;
            box-shadow: 
                /* Top-left Highlight */
                inset 2px 2px 5px rgba(255, 255, 255, 0.15),
                /* Bottom-right Shadow */
                inset -3px -3px 8px rgba(0, 0, 0, 0.6),
                /* Deep Drop Shadow for 3D lift */
                0 30px 60px rgba(0, 0, 0, 0.8);

            padding: 50px;
            width: 90%;
            max-width: 800px;
            text-align: center;
            border: 1px solid rgba(0,0,0,0.3);
        }

        /* Shake Animation */
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* --- TYPOGRAPHY --- */
        .gold-text {
            /* Gold Gradient Fill */
            background: linear-gradient(to bottom, var(--gold-light) 0%, var(--gold-mid) 50%, var(--gold-dark) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            
            /* Physical ridge effect via drop-shadow since text-shadow doesn't work well with background-clip */
            filter: drop-shadow(0px 2px 0px rgba(0,0,0,0.5));
        }

        h1.title-main {
            font-family: "Fleur De Leah", cursive;
            font-size: 5rem;
            margin: 0;
            /* Increased line-height to prevent cropping of fancy swashes */
            line-height: 1.2; 
            padding-bottom: 20px;
            transform: rotate(-2deg); /* Jaunty angle */
            overflow: visible; /* Ensure nothing gets clipped */
        }

        h2.subtitle {
            font-family: "Henny Penny", system-ui;
            font-size: 2.2rem;
            margin: 0 0 40px 0;
            opacity: 0.9;
            letter-spacing: 1px;
        }

        /* --- SLOTS --- */
        .slots-wrapper {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .slot-window {
            /* Forest Green Base */
            background: #0f3b1e;
            
            /* Cylindrical Illusion */
            /* We use inset shadows to make the top and bottom look curved away from the light */
            box-shadow: 
                inset 0px 25px 30px -5px rgba(0,0,0,0.8),
                inset 0px -25px 30px -5px rgba(0,0,0,0.8),
                0 0 0 4px #1a1a1a, /* Inner bezel */
                0 0 0 6px var(--gold-dark); /* Outer gold trim */

            border-radius: 12px;
            width: 100%;
            max-width: 300px;
            height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .slot-label {
            position: absolute;
            top: 8px;
            font-family: "Henny Penny", system-ui;
            font-size: 1.0rem;
            color: rgba(255,255,255,0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 2;
        }

        .reel-text {
            font-family: "Henny Penny", system-ui;
            font-size: 1.8rem;
            line-height: 1.1;
            padding: 0 20px;
            z-index: 1;
        }

        /* --- BUTTONS --- */
        .buttons-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        button.action-btn {
            font-family: "Henny Penny", system-ui;
            font-size: 2.5rem;
            text-transform: capitalize; 
            letter-spacing: 1px;
            color: #3e2704; /* Dark gold/brown text */
            
            /* Gold Bar Gradient */
            background: linear-gradient(180deg, var(--gold-light) 0%, var(--gold-mid) 40%, var(--gold-dark) 100%);
            
            border: none;
            padding: 15px 60px;
            border-radius: 12px;
            cursor: pointer;
            
            /* Bevel */
            box-shadow: 
                inset 1px 1px 0px rgba(255,255,255,0.4),
                inset -1px -1px 0px rgba(0,0,0,0.2),
                0px 5px 10px rgba(0,0,0,0.5);
                
            transition: transform 0.1s, box-shadow 0.1s;
        }

        button.action-btn:active {
            transform: translateY(2px);
            box-shadow: 
                inset 1px 1px 2px rgba(0,0,0,0.3),
                0px 2px 5px rgba(0,0,0,0.5);
        }
        
        button.action-btn:disabled {
            filter: grayscale(0.8) brightness(0.7);
            cursor: not-allowed;
        }
        
        /* Secondary Style for Sing Button */
        button#singBtn {
            display: none; /* Hidden by default */
        }

        .status {
            margin-top: 25px;
            font-size: 1.2rem;
            color: var(--gold-mid);
            opacity: 0.8;
        }

        /* --- VIDEO OVERLAY --- */
        .video-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            border-radius: 18px; /* Match container minus border */
            z-index: 50;
            flex-direction: column;
            overflow: hidden;
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .video-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .close-video {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--gold-mid);
            color: var(--velvet-base);
            border: 2px solid #fff;
            font-family: "Henny Penny", system-ui;
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 60;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .close-video:hover {
            background: #fff;
            color: red;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 200; /* Higher than burst canvas */
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: radial-gradient(circle, var(--velvet-highlight), var(--velvet-base));
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 2px solid var(--gold-mid);
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.2);
        }
        .modal h2 { margin-top: 0; color: var(--gold-light); font-size: 3rem; font-family: "Fleur De Leah", cursive; line-height: 1.2;}
        .modal p { color: var(--gold-mid); font-size: 1.5rem; }

        @media (max-width: 600px) {
            h1.title-main { font-size: 3.5rem; }
            h2.subtitle { font-size: 1.6rem; margin-bottom: 20px; }
            .slot-window { height: 100px; }
            .reel-text { font-size: 1.4rem; }
            .machine-container { padding: 30px 15px; }
            .buttons-row { gap: 10px; }
            button.action-btn { padding: 10px 30px; font-size: 1.8rem; }
        }
    </style>
</head>
<body>

    <!-- WebGL Background (z:0) -->
    <canvas id="glCanvas"></canvas>
    <!-- Falling Snow Overlay (z:1) -->
    <canvas id="snowCanvas"></canvas>
    <!-- Burst Overlay (z:100) -->
    <canvas id="burstCanvas"></canvas>

    <div class="machine-container" id="machine">
        
        <!-- Video Overlay (Hidden by default) -->
        <div id="videoOverlay" class="video-overlay">
            <div class="video-container">
                <button class="close-video" onclick="closeVideo()">X</button>
                <div id="playerTarget" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:white;">
                    <!-- Iframe injects here -->
                </div>
            </div>
        </div>

        <h1 class="title-main gold-text">FitzMas</h1>
        <h2 class="subtitle gold-text">Karaok-atron 3000</h2>

        <div class="slots-wrapper">
            <div class="slot-window">
                <span class="slot-label">Singer</span>
                <div id="reel-name" class="reel-text gold-text">Ready?</div>
            </div>
            <div class="slot-window">
                <span class="slot-label">Song</span>
                <div id="reel-song" class="reel-text gold-text">Spin to Win</div>
            </div>
        </div>

        <div class="buttons-row">
            <button id="spinBtn" class="action-btn" onclick="spin()">Spin!</button>
            <button id="singBtn" class="action-btn" onclick="sing()">Sing!</button>
        </div>

        <div class="status">
            Singers remaining: <span id="count">21</span>
        </div>
    </div>

    <!-- Game Over Modal (z:200) -->
    <div id="gameOverModal" class="modal">
        <div class="modal-content">
            <h2>Party Complete!</h2>
            <p>All colleagues have been selected!</p>
            <button onclick="location.reload()" style="margin-top:20px; background:var(--gold-mid); border:none; padding:10px 20px; font-family:'Henny Penny'; font-size:1.5rem; cursor:pointer; border-radius:5px;">Restart</button>
        </div>
    </div>

    <!-- SHADERS -->
    <script id="vertex-shader" type="x-shader/x-vertex">
        attribute vec2 a_position;
        void main() {
            gl_Position = vec4(a_position, 0.0, 1.0);
        }
    </script>

    <script id="fragment-shader" type="x-shader/x-fragment">
        precision mediump float;
        uniform vec2 u_resolution;
        uniform float u_time;

        // Simplex 3D Noise
        vec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
        vec4 mod289(vec4 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
        vec4 permute(vec4 x) { return mod289(((x*34.0)+1.0)*x); }
        vec4 taylorInvSqrt(vec4 r) { return 1.79284291400159 - 0.85373472095314 * r; }
        float snoise(vec3 v) { 
            const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;
            const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);
            vec3 i  = floor(v + dot(v, C.yyy) );
            vec3 x0 = v - i + dot(i, C.xxx) ;
            vec3 g = step(x0.yzx, x0.xyz);
            vec3 l = 1.0 - g;
            vec3 i1 = min( g.xyz, l.zxy );
            vec3 i2 = max( g.xyz, l.zxy );
            vec3 x1 = x0 - i1 + C.xxx;
            vec3 x2 = x0 - i2 + C.yyy;
            vec3 x3 = x0 - D.yyy;
            i = mod289(i); 
            vec4 p = permute( permute( permute( 
                        i.z + vec4(0.0, i1.z, i2.z, 1.0 ))
                    + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) 
                    + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));
            float n_ = 0.142857142857;
            vec3  ns = n_ * D.wyz - D.xzx;
            vec4 j = p - 49.0 * floor(p * ns.z * ns.z);
            vec4 x_ = floor(j * ns.z);
            vec4 y_ = floor(j - 7.0 * x_ );
            vec4 x = x_ *ns.x + ns.yyyy;
            vec4 y = y_ *ns.x + ns.yyyy;
            vec4 h = 1.0 - abs(x) - abs(y);
            vec4 b0 = vec4( x.xy, y.xy );
            vec4 b1 = vec4( x.zw, y.zw );
            vec4 s0 = floor(b0)*2.0 + 1.0;
            vec4 s1 = floor(b1)*2.0 + 1.0;
            vec4 sh = -step(h, vec4(0.0));
            vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;
            vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;
            vec3 p0 = vec3(a0.xy,h.x);
            vec3 p1 = vec3(a0.zw,h.y);
            vec3 p2 = vec3(a1.xy,h.z);
            vec3 p3 = vec3(a1.zw,h.w);
            vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));
            p0 *= norm.x;
            p1 *= norm.y;
            p2 *= norm.z;
            p3 *= norm.w;
            vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);
            m = m * m;
            return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), 
                                        dot(p2,x2), dot(p3,x3) ) );
        }

        void main() {
            vec2 st = gl_FragCoord.xy / u_resolution.xy;
            st.x *= u_resolution.x / u_resolution.y;
            // Colors
            vec3 colorBg = vec3(0.05, 0.15, 0.1); 
            vec3 colorCloud = vec3(0.29, 0.05, 0.05); 
            // Noise evolution
            float n = snoise(vec3(st * 1.5, u_time * 0.1));
            float n2 = snoise(vec3(st * 4.0 + vec2(u_time*0.05), u_time * 0.15));
            float mask = smoothstep(-0.2, 0.6, n + n2 * 0.5);
            vec3 finalColor = mix(colorBg, colorCloud, mask);
            // Vignette
            vec2 uv = gl_FragCoord.xy / u_resolution.xy;
            float vignette = 1.0 - length(uv - 0.5) * 0.8;
            finalColor *= vignette;
            gl_FragColor = vec4(finalColor, 1.0);
        }
    </script>

    <script>
        // --- 1. WEBGL BACKGROUND ---
        const glCanvas = document.getElementById('glCanvas');
        const gl = glCanvas.getContext('webgl');
        let program, positionLocation, resolutionLocation, timeLocation, buffer;

        function createShader(gl, type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) return null;
            return shader;
        }

        function initWebGL() {
            if (!gl) return;
            const vertexSource = document.getElementById('vertex-shader').text;
            const fragmentSource = document.getElementById('fragment-shader').text;
            const vertexShader = createShader(gl, gl.VERTEX_SHADER, vertexSource);
            const fragmentShader = createShader(gl, gl.FRAGMENT_SHADER, fragmentSource);
            program = gl.createProgram();
            gl.attachShader(program, vertexShader);
            gl.attachShader(program, fragmentShader);
            gl.linkProgram(program);
            if (!gl.getProgramParameter(program, gl.LINK_STATUS)) return;

            positionLocation = gl.getAttribLocation(program, "a_position");
            resolutionLocation = gl.getUniformLocation(program, "u_resolution");
            timeLocation = gl.getUniformLocation(program, "u_time");
            buffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]), gl.STATIC_DRAW);
        }

        function resizeWebGL() {
            const w = window.innerWidth;
            const h = window.innerHeight;
            glCanvas.width = w; glCanvas.height = h;
            snowCanvas.width = w; snowCanvas.height = h;
            burstCanvas.width = w; burstCanvas.height = h;
            gl.viewport(0, 0, w, h);
        }

        // --- 2. SNOW & BURST ---
        const snowCanvas = document.getElementById('snowCanvas');
        const snowCtx = snowCanvas.getContext('2d');
        const burstCanvas = document.getElementById('burstCanvas');
        const burstCtx = burstCanvas.getContext('2d');
        
        let flakes = [];
        let burstParticles = [];
        let wind = 0;

        function initSnow() {
            flakes = [];
            for(let i=0; i<70; i++) {
                flakes.push({
                    x: Math.random() * snowCanvas.width,
                    y: Math.random() * snowCanvas.height,
                    radius: Math.random() * 3 + 1,
                    speed: Math.random() * 1 + 0.5,
                    sway: Math.random() * 0.05,
                    offset: Math.random() * Math.PI * 2
                });
            }
        }

        function createSnowBurst() {
            const centerX = burstCanvas.width / 2;
            const centerY = burstCanvas.height / 2;
            
            for(let i=0; i<200; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 15 + 5; // Faster explosion
                burstParticles.push({
                    x: centerX,
                    y: centerY,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    radius: Math.random() * 5 + 2,
                    alpha: 1.0,
                    decay: Math.random() * 0.015 + 0.005,
                    gravity: 0.2
                });
            }
        }

        function updateAndDraw(time) {
            // Draw WebGL
            gl.useProgram(program);
            gl.enableVertexAttribArray(positionLocation);
            gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
            gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);
            gl.uniform2f(resolutionLocation, glCanvas.width, glCanvas.height);
            gl.uniform1f(timeLocation, time * 0.001);
            gl.drawArrays(gl.TRIANGLES, 0, 6);

            // Wind
            wind = Math.sin(time * 0.0005) * 1.5;

            // --- DRAW FALLING SNOW (Layer 1) ---
            snowCtx.clearRect(0, 0, snowCanvas.width, snowCanvas.height);
            snowCtx.fillStyle = "rgba(255, 255, 255, 0.6)";
            snowCtx.beginPath();
            
            for(let f of flakes) {
                f.y += f.speed;
                f.x += wind + Math.sin((time * 0.002) + f.offset) * 0.5;
                if (f.y > snowCanvas.height) f.y = -5;
                if (f.x > snowCanvas.width) f.x = 0;
                if (f.x < 0) f.x = snowCanvas.width;
                snowCtx.moveTo(f.x, f.y);
                snowCtx.arc(f.x, f.y, f.radius, 0, Math.PI * 2);
            }
            snowCtx.fill();

            // --- DRAW BURST (Layer 100) ---
            burstCtx.clearRect(0, 0, burstCanvas.width, burstCanvas.height);
            if (burstParticles.length > 0) {
                for (let i = burstParticles.length - 1; i >= 0; i--) {
                    let p = burstParticles[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += p.gravity;
                    p.alpha -= p.decay;

                    if (p.alpha <= 0) {
                        burstParticles.splice(i, 1);
                        continue;
                    }

                    burstCtx.beginPath();
                    burstCtx.fillStyle = "rgba(255, 255, 255, " + p.alpha + ")";
                    burstCtx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    burstCtx.fill();
                }
            }

            requestAnimationFrame(updateAndDraw);
        }

        // --- 3. GAME LOGIC ---
        let colleagues = [
            "Floortje", "Fatima", "Marlon", "Anne-Marie", "Jur", "Orfee", 
            "Jannieke", "Rafael", "Alex", "Andrea", "Derk", "Emma", 
            "Eva", "Iris", "Joris", "Koos", "Lili", "Marnix", 
            "Marten", "Mischa", "Reinier"
        ];
        
        let songs = [
            { title: "Driving home for Christmas", id: "pC49TjLzaeU" },
            { title: "All I want for Christmas is You", id: "RmUWWVZw28E" },
            { title: "I'm Dreaming of a White Christmas", id: "d69vjlOw3Nw" },
            { title: "Frosty the Snowman", id: "k6zW225k_O0" },
            { title: "Rudolph the Red Nosed Reindeer", id: "JgjkQ0Aoqv8" },
            { title: "Santa Baby", id: "r18245qynyE" },
            { title: "Last Christmas", id: "KhqNTjbQ71A" },
            { title: "Feliz Navidad", id: "cRbLtqbPYjU" },
            { title: "I saw mommy kissing Santa Claus", id: "5mgjYTtUu-o" },
            { title: "Rocking around the Christmas tree", id: "i8gUYDoLbD4" },
            { title: "Run Run Rudolph", id: "Lk8ctQxStyk" },
            { title: "Let it snow", id: "Km-Nlo5bgCQ" },
            { title: "Santa tell me", id: "ONpZ6JLcvYY" },
            { title: "Holly Jolly Christmas", id: "wOwXRp1JK1A" },
            { title: "Jingle Bell Rock", id: "fyEAX7Cd3OE" },
            { title: "Winter Wonderland", id: "ZBlwZym4dfk" },
            { title: "The Christmas song", id: "FLPi8RRvAlU" },
            { title: "It's the most wonderful time of the year", id: "wcddNN9gwiw" },
            { title: "Have yourself a merry little christmas", id: "3RHpgLZzXbk" },
            { title: "Sleigh ride", id: "k1OBqhJ8Ig0" },
            { title: "It's beginning to look a lot like Christmas", id: "uE60iiHvabk" },
            { title: "I want a hippopotamus for xmas", id: "57vrqCENNPc" },
            { title: "My Only Wish", id: "j7Tksexm680" },
            { title: "Little Saint Nick", id: "AbgxDgVmMF0" },
            { title: "Deck the Halls", id: "kORRidv-p0Y" },
            { title: "You're a mean one, Mr Grinch", id: "XKWZ8p3pDQg" },
            { title: "Mele Kalikimaka", id: "s06qX5Jn_yM" }
        ];

        const reelName = document.getElementById('reel-name');
        const reelSong = document.getElementById('reel-song');
        const spinBtn = document.getElementById('spinBtn');
        const singBtn = document.getElementById('singBtn');
        const countSpan = document.getElementById('count');
        const modal = document.getElementById('gameOverModal');
        const machineDiv = document.getElementById('machine');
        const videoOverlay = document.getElementById('videoOverlay');
        const playerTarget = document.getElementById('playerTarget');
        
        let isSpinning = false;
        let currentVideoId = ""; 

        function spin() {
            if (isSpinning) return;
            if (colleagues.length === 0) {
                modal.style.display = 'flex';
                return;
            }

            isSpinning = true;
            spinBtn.disabled = true;
            spinBtn.innerText = "Spinning...";
            
            // Hide Sing Button while spinning
            singBtn.style.display = "none";

            let delay = 50; 
            let iterations = 0;
            const minIterations = 20;

            const spinLoop = () => {
                const nameIdx = Math.floor(Math.random() * colleagues.length);
                const songIdx = Math.floor(Math.random() * songs.length);
                
                reelName.innerText = colleagues[nameIdx];
                // Access .title since songs is now an array of objects
                reelSong.innerText = songs.length > 0 ? songs[songIdx].title : "Free Choice!";
                
                iterations++;

                if (iterations > minIterations) {
                    delay = Math.floor(delay * 1.15);
                }

                if (delay < 600) {
                    setTimeout(spinLoop, delay);
                } else {
                    finishSpin(nameIdx, songIdx);
                }
            };
            spinLoop();
        }

        function finishSpin(nameIdx, songIdx) {
            // Update UI with winning singer
            reelName.innerText = colleagues[nameIdx];
            
            // Update UI with winning song and store ID
            if (songs.length > 0) {
                reelSong.innerText = songs[songIdx].title;
                currentVideoId = songs[songIdx].id;
                
                // Remove song from pool to avoid repeats
                songs.splice(songIdx, 1);
            }

            // Remove colleague from pool
            colleagues.splice(nameIdx, 1);

            countSpan.innerText = colleagues.length;
            isSpinning = false;
            
            // Trigger Effects
            createSnowBurst();
            
            // Add shake class then remove it
            machineDiv.classList.add('shake');
            setTimeout(() => {
                machineDiv.classList.remove('shake');
            }, 500);
            
            if (colleagues.length === 0) {
                spinBtn.innerText = "Finale!";
                setTimeout(() => { modal.style.display = 'flex'; }, 1000);
            } else {
                spinBtn.disabled = false;
                spinBtn.innerText = "Spin Again";
                // Show Sing Button if we have a valid video ID
                if (currentVideoId) {
                    singBtn.style.display = "block";
                }
            }
        }

        function sing() {
            if (!currentVideoId) return;
            // Embed YouTube Video
            const embedUrl = `https://www.youtube.com/embed/${currentVideoId}?autoplay=1`;
            playerTarget.innerHTML = `<iframe src="${embedUrl}" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
            videoOverlay.style.display = 'flex';
        }

        function closeVideo() {
            videoOverlay.style.display = 'none';
            playerTarget.innerHTML = ''; // Kill the iframe to stop audio
        }

        // --- INIT ---
        window.addEventListener('resize', () => {
            resizeWebGL();
            initSnow();
        });
        
        initWebGL();
        resizeWebGL();
        initSnow();
        requestAnimationFrame(updateAndDraw);

    </script>
</body>
</html>
